<!doctype html>
<html lang="pt-br">
{% load static %}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Chama do Cerrado{% endblock %}</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    
    <style>
        body { padding-top: 56px; } /* Ajuste para navbar fixa */
        .sticky-top { top: 70px; } /* Offset para elementos sticky */
    </style>
</head>
<body class="{% if user.is_authenticated and user.is_staff %}theme-staff{% else %}theme-client{% endif %}">

<nav class="navbar navbar-dark fixed-top">
    <div class="container">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"><i class="bi bi-list"></i></button>
        <a class="navbar-brand mx-auto" href="{% if not user.is_staff or not user.is_authenticated %}{% url 'inicio' %}{% else %}#{% endif %}">Chama do Cerrado</a>
        <div style="width: 50px;"></div> </div>
</nav>

<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasNavbar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu Principal</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
        <li class="nav-item"><a class="nav-link" href="{% url 'inicio' %}"><i class="bi bi-house-door me-2"></i>Início</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'cardapio' %}"><i class="bi bi-book me-2"></i>Cardápio</a></li>
        
        {% if not user.is_staff %}
            <li class="nav-item"> 
                {% if request.resolver_match.url_name == 'inicio' %}
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalFila"><i class="bi bi-people me-2"></i>Entrar na Fila</a> 
                {% else %} 
                    <a class="nav-link" href="{% url 'pagina_fila' %}"><i class="bi bi-people me-2"></i>Fila de Espera</a> 
                {% endif %} 
            </li>
            <li class="nav-item"> 
                {% if user.is_authenticated and not user.is_staff %} 
                    {% if request.resolver_match.url_name == 'inicio' %} 
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalReserva"><i class="bi bi-calendar-check me-2"></i>Fazer Reserva</a> 
                    {% else %} 
                        <a class="nav-link" href="{% url 'fazer_reserva' %}"><i class="bi bi-calendar-check me-2"></i>Reservas</a> 
                    {% endif %} 
                {% elif not user.is_authenticated %} 
                    <a class="nav-link" href="{% url 'fazer_reserva' %}"><i class="bi bi-calendar-check me-2"></i>Reservas</a> 
                {% endif %} 
            </li>
        {% endif %} {# Fim do bloco not user.is_staff #}

        {% if user.is_authenticated and user.is_staff %}
            <hr class="text-secondary">
            <li class="nav-item"><a class="nav-link" href="{% url 'mapa_mesas' %}"><i class="bi bi-grid-3x3-gap me-2"></i>PDV Mesas</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'gerenciar_fila' %}"><i class="bi bi-person-lines-fill me-2"></i>Gerenciar Fila</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'gerenciar_reservas' %}"><i class="bi bi-calendar3 me-2"></i>Gerenciar Reservas</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'gerenciar_cardapio' %}"><i class="bi bi-pencil-square me-2"></i>Gerenciar Cardápio</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'gerenciar_estoque' %}"><i class="bi bi-box-seam me-2"></i>Gerenciar Estoque</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'relatorio_diario' %}"><i class="bi bi-graph-up me-2"></i>Relatório Diário</a></li>
        {% endif %}
    </ul>
    <ul class="navbar-nav mt-auto pe-3">
         {% if user.is_authenticated %}
             {% if user.is_staff %}
                 <li class="nav-item"> <form action="{% url 'logout' %}" method="post">{% csrf_token %}<button type="submit" class="nav-link text-danger bg-transparent border-0 w-100 text-start"><i class="bi bi-box-arrow-right me-2"></i>Sair (Staff)</button></form> </li>
             {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'perfil' %}"><i class="bi bi-person-circle me-2"></i>Meu Perfil</a></li>
                <li class="nav-item"> <form action="{% url 'logout' %}" method="post">{% csrf_token %}<button type="submit" class="nav-link text-danger bg-transparent border-0 w-100 text-start"><i class="bi bi-box-arrow-right me-2"></i>Sair</button></form> </li>
             {% endif %}
         {% else %}
             <li class="nav-item"><a class="nav-link" href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right me-2"></i>Login / Cadastre-se</a></li>
         {% endif %}
    </ul>
  </div>
</div>

<main class="container mt-4 mb-5">
    {% if messages %} {% for message in messages %} <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div> {% endfor %} {% endif %}
    {% block content %}{% endblock %}
</main>

<footer class="footer mt-auto py-3 text-center">
    <div class="container"><span class="text-muted">&copy; {% now "Y" %} Chama do Cerrado.</span></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% if id_cliente_na_fila and status_cliente_na_fila == 'AGUARDANDO' %}
    <div class="queue-balloon" id="queueBalloon">
        <button type="button" class="close-balloon" id="closeQueueBalloon">&times;</button>
        <p class="mb-1">Você está na fila!</p>
        <span class="d-block">Sua posição é:</span>
        <strong id="queuePosition">{{ posicao_cliente_na_fila }}º</strong>
        <a href="{% url 'sair_da_fila_cliente' %}" class="btn btn-sm btn-outline-danger mt-2 d-block">Sair da Fila</a>
    </div>
{% elif status_cliente_na_fila == 'CHAMADO' %}
    <div class="queue-balloon bg-success text-white" id="queueBalloon">
        <button type="button" class="close-balloon" id="closeQueueBalloon" style="color: #fff;">&times;</button>
        <strong>É a sua vez!</strong> <p class="mb-0">Dirija-se à recepção.</p>
    </div>
{% endif %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const queueBalloon = document.getElementById('queueBalloon');
        if (queueBalloon) {
            queueBalloon.style.display = 'block';
            const closeButton = document.getElementById('closeQueueBalloon');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    queueBalloon.style.display = 'none';
                    if (window.queueCheckInterval) clearInterval(window.queueCheckInterval);
                });
            }
            const positionElement = document.getElementById('queuePosition');
            if (positionElement) {
                const checkPosition = async () => {
                    try {
                        const response = await fetch("{% url 'checar_posicao' %}");
                        if (!response.ok) { queueBalloon.style.display = 'none'; clearInterval(window.queueCheckInterval); return; }
                        const data = await response.json();
                        if (data.status === 'AGUARDANDO') {
                            positionElement.textContent = data.posicao + 'º';
                        } else if (data.status === 'CHAMADO') {
                            queueBalloon.className = 'queue-balloon bg-success text-white';
                            queueBalloon.innerHTML = `<button type="button" class="close-balloon" id="closeQueueBalloon" style="color: #fff;">&times;</button><strong>É a sua vez!</strong><p class="mb-0">Dirija-se à recepção.</p>`;
                            document.getElementById('closeQueueBalloon').addEventListener('click', () => { queueBalloon.style.display = 'none'; });
                            clearInterval(window.queueCheckInterval);
                        } else { queueBalloon.style.display = 'none'; clearInterval(window.queueCheckInterval); }
                    } catch (error) { console.error('Erro ao checar posição:', error); if (window.queueCheckInterval) clearInterval(window.queueCheckInterval); }};
                window.queueCheckInterval = setInterval(checkPosition, 15000);
            }});
</script>
{% endblock %}
</body>
</html>