{% extends 'staff_base.html' %}
{% load static %}
{% load auth_extras %} {% block title %}Mapa de Mesas{% endblock %}

{% block main_content %}
<div class="container-fluid mt-4">
    
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="h4 mb-0">
                {% if cliente_a_alocar %}
                    <i class="bi bi-person-plus-fill text-primary me-2"></i> Alocar Cliente: <strong>{{ cliente_a_alocar.nome }}</strong> ({{ cliente_a_alocar.quantidade }}p)
                {% else %}
                    PDV - Mapa de Mesas
                {% endif %}
            </h2>
            {% if cliente_a_alocar %}
                <small class="text-muted">Selecione uma mesa 'Livre' abaixo para alocar o cliente.</small>
            {% else %}
                 <small class="text-muted">Visão geral do salão.</small>
            {% endif %}
        </div>

        {% if request.user|has_group:"Gerente" and not cliente_a_alocar %}
        <div class="col-md-4">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-header bg-darker">
                    <h5 class="mb-0">Próximo na Fila</h5>
                </div>
                <div class="card-body text-center">
                    {% if proximo_cliente %}
                        <h4 class="mb-1">{{ proximo_cliente.nome }}</h4>
                        <p class="fs-6 text-muted mb-2">{{ proximo_cliente.quantidade }} pessoas (às {{ proximo_cliente.timestamp_entrada|time:"H:i" }})</p>
                        <a href="{% url 'mapa_mesas' %}?alocar_cliente_id={{ proximo_cliente.id }}" class="btn btn-primary btn-sm w-100">
                            INICIAR ALOCAÇÃO
                        </a>
                    {% else %}
                        <p class="mb-0 text-muted">A fila está vazia.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row g-3">
        {% for mesa in mesas %}
            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                
                {% if cliente_a_alocar and mesa.status == 'LIVRE' %}
                    <a href="{% url 'processar_alocacao_cliente' id_mesa=mesa.id id_cliente=cliente_a_alocar.id %}" 
                       class="card-mesa-link text-decoration-none" 
                       onclick="return confirm('Alocar {{ cliente_a_alocar.nome }} na Mesa {{ mesa.numero }}?')">
                        <div class="card card-mesa status-livre shadow-sm text-center">
                            <div class="card-body">
                                <h3 class="card-title mb-0">Mesa {{ mesa.numero }}</h3>
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">{{ mesa.get_status_display }}</span>
                                <div class="mt-2 text-success-emphasis">
                                    <i class="bi bi-check-circle-fill fs-3"></i><br>
                                    <strong>Alocar Cliente</strong>
                                </div>
                            </div>
                        </div>
                    </a>
                
                {% elif request.user|has_group:"Gerente" and mesa.status == 'OCUPADA' or request.user|has_group:"Gerente" and mesa.status == 'PAGAMENTO' %}
                
                    <a href="{% url 'detalhe_comanda' mesa.id %}" class="card-mesa-link text-decoration-none">
                        <div class="card card-mesa {% if mesa.status == 'OCUPADA' %}status-ocupada{% else %}status-pagamento{% endif %} shadow-sm text-center">
                            <div class="card-body">
                                <h3 class="card-title mb-0">Mesa {{ mesa.numero }}</h3>
                                {% if mesa.status == 'OCUPADA' %}
                                    <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">{{ mesa.get_status_display }}</span>
                                {% else %}
                                    <span class="badge bg-info-subtle text-info-emphasis rounded-pill">{{ mesa.get_status_display }}</span>
                                {% endif %}
                                <div class="mt-2 {% if mesa.status == 'OCUPADA' %}text-danger-emphasis{% else %}text-info-emphasis{% endif %}">
                                    <i class="bi bi-file-earmark-text-fill fs-3"></i><br>
                                    <strong>Ver Comanda</strong>
                                </div>
                            </div>
                        </div>
                    </a>
                
                {% else %}
                    <div class="card card-mesa {% if mesa.status == 'LIVRE' %}status-livre{% else %}status-indisponivel{% endif %} shadow-sm text-center opacity-50">
                        <div class="card-body">
                            <h3 class="card-title mb-0">Mesa {{ mesa.numero }}</h3>
                            {% if mesa.status == 'LIVRE' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">{{ mesa.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ mesa.get_status_display }}</span>
                            {% endif %}
                            <div class="mt-2 text-muted">
                                <i class="bi {% if mesa.status == 'LIVRE' %}bi-check-circle-fill{% else %}bi-x-circle-fill{% endif %} fs-3"></i><br>
                                {% if cliente_a_alocar %}
                                    <strong>Indisponível</strong>
                                {% else %}
                                    <strong>Livre</strong>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}

            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-warning">
                    Nenhuma mesa cadastrada. Por favor, peça ao Superusuário para cadastrar as mesas no painel /admin.
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}