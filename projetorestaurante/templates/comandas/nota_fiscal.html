{% extends "staff_base.html" %} {# Herda da base do staff para ter o menu lateral #}
{% load static %}
{% load i18n %}

{% block title %}Recibo - Mesa {{ comanda.mesa.numero }}{% endblock %}

{% block main_content %} {# Usa o bloco de conteúdo principal do staff_base #}

<div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
    <h2 class="mb-0">Pré-Fechamento (Recibo)</h2>
    <div>
        <a href="{% url 'detalhe_comanda' comanda.mesa.id %}" class="btn btn-outline-secondary"><i class="bi bi-pencil me-1"></i> Voltar à Comanda</a>
        <button onclick="window.print();" class="btn btn-primary"><i class="bi bi-printer me-1"></i> Imprimir</button>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <div class="card shadow-sm" id="area-recibo" style="font-family: 'Courier New', Courier, monospace; color: #000; background-color: #fff;">
            <div class="card-body p-4">
                
                <div class="text-center mb-4">
                    <h3 class="h4 mb-1">CHAMA DO CERRADO</h3>
                    <p class="mb-0 small">Endereço: Rua dos XXXXX, 123 - Bairro YYYYY</p>
                    <p class="mb-0 small">CNPJ: 00.000.000/0001-00</p>
                    <p class="mb-0 small">Data: {{ comanda.timestamp_fechamento|date:"d/m/Y H:i:s" }}</p>
                    <hr style="border-style: dashed; border-color: #000;">
                    <h4 class="h6 mb-0">CUPOM NÃO FISCAL</h4>
                    <h5 class="h6 mb-0">Mesa: {{ comanda.mesa.numero }}</h5>
                    <hr style="border-style: dashed; border-color: #000;">
                </div>

                <h5 class="mb-2 small text-uppercase">Itens Consumidos:</h5>
                <table class="table table-sm" style="color: #000; font-size: 0.9em;">
                    <thead>
                        <tr>
                            <th scope="col">Qtd.</th>
                            <th scope="col">Descrição</th>
                            <th scope="col" class="text-end">Vl. Unit.</th>
                            <th scope="col" class="text-end">Vl. Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itens_comanda %}
                        <tr>
                            <td>{{ item.quantidade }}x</td>
                            <td>
                                {{ item.item_cardapio.nome }}
                                {% if item.observacao %}<br><small class="fst-italic">Obs: {{ item.observacao }}</small>{% endif %}
                            </td>
                            <td class="text-end">R${{ item.preco_unitario_momento|stringformat:".2f" }}</td>
                            <td class="text-end">R${{ item.get_total_item|stringformat:".2f" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <hr style="border-style: dashed; border-color: #000;">

                <div class="row justify-content-end" style="font-size: 0.9em;">
                    <div class="col-7">
                        <ul class="list-unstyled mb-0">
                            <li class="d-flex justify-content-between">
                                <span>Subtotal</span>
                                <strong>R$ {{ subtotal|stringformat:".2f" }}</strong>
                            </li>
                            {% if comanda.incluir_taxa_servico %}
                            <li class="d-flex justify-content-between">
                                <span>Taxa de Serviço (10%)</span>
                                <strong>R$ {{ taxa_servico|stringformat:".2f" }}</strong>
                            </li>
                            {% endif %}
                            <li class="d-flex justify-content-between fs-5 mt-2 pt-2" style="border-top: 1px dashed #000;">
                                <strong class="text-uppercase">TOTAL A PAGAR</strong>
                                <strong>R$ {{ total_geral|stringformat:".2f" }}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <hr style="border-style: dashed; border-color: #000;">
                <p class="text-center small mt-3 mb-0">Obrigado pela preferência!</p>

                <div class="d-print-none mt-5 text-center">
                    <hr>
                    <h5 class="mb-3" style="color: var(--staff-titulo);">Confirmar Pagamento</h5>
                    <p class="text-muted">Clique abaixo para confirmar o recebimento e liberar a mesa.</p>
                    <a href="{% url 'confirmar_pagamento' comanda.id %}" class="btn btn-success btn-lg px-5">
                        <i class="bi bi-check-circle me-2"></i> Pagamento Confirmado
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}