{% extends "staff_base.html" %}
{% load static %}

{% block title %}Gerenciar Cardápio{% endblock %}

{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Gerenciar Cardápio</h2>
    <div>
        <a href="{% url 'adicionar_categoria' %}" class="btn btn-sm btn-outline-primary me-2">Nova Categoria</a>
        <a href="{% url 'adicionar_item' %}" class="btn btn-sm btn-primary">Novo Item</a>
    </div>
</div>

{% for categoria in categorias %}
<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ categoria.nome }}</h5>
        <div>
            <a href="{% url 'editar_categoria' categoria.id %}" class="btn btn-sm btn-outline-secondary">Editar Cat.</a>
            <a href="{% url 'deletar_categoria' categoria.id %}" class="btn btn-sm btn-outline-danger">Deletar Cat.</a>
        </div>
    </div>
    <div class="card-body p-0">
        {% if categoria.itens.all %}
        <ul class="list-group list-group-flush">
            {% for item in categoria.itens.all %}
            <li class="list-group-item d-flex flex-wrap justify-content-between align-items-center">
                <div class="me-3 mb-2 mb-md-0">
                    {% if item.imagem %}
                        <img src="{{ item.imagem.url }}" alt="{{ item.nome }}" width="50" height="50" class="me-2 rounded object-fit-cover float-start">
                    {% endif %}
                    <strong style="{% if not item.ativo %}text-decoration: line-through; color: grey;{% endif %}">{{ item.nome }}</strong>
                    {% if not item.ativo %} <span class="badge bg-secondary ms-1">Inativo</span> {% endif %}
                    <small class="d-block text-muted">{{ item.descricao|truncatewords:10 }}</small>
                    <span class="d-block mt-1">Preço Atual: R$ {{ item.preco|stringformat:".2f" }}</span>
                </div>
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <form method="POST" action="{% url 'atualizar_preco_item' item.id %}" class="d-inline-flex align-items-center me-2">
                        {% csrf_token %}
                        <label for="preco-{{ item.id }}" class="form-label visually-hidden">Novo Preço</label>
                        <input type="number" name="novo_preco" value="{{ item.preco }}" step="0.01" class="form-control form-control-sm" style="width: 90px;" id="preco-{{ item.id }}" required>
                        <button type="submit" class="btn btn-sm btn-outline-success ms-1" title="Salvar Preço"><i class="bi bi-check-lg"></i></button>
                    </form>
                    <a href="{% url 'toggle_ativo_item' item.id %}" class="btn btn-sm {% if item.ativo %}btn-outline-warning{% else %}btn-outline-success{% endif %}" title="{% if item.ativo %}Desativar{% else %}Ativar{% endif %}">
                        {% if item.ativo %}<i class="bi bi-eye-slash"></i>{% else %}<i class="bi bi-eye"></i>{% endif %}
                    </a>
                    <a href="{% url 'editar_item' item.id %}" class="btn btn-sm btn-outline-secondary" title="Editar Completo"><i class="bi bi-pencil"></i></a>
                    <a href="{% url 'deletar_item' item.id %}" class="btn btn-sm btn-outline-danger" title="Deletar"><i class="bi bi-trash"></i></a>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %} <p class="text-muted text-center p-3 mb-0">Nenhum item nesta categoria.</p> {% endif %}
    </div>
</div>
{% empty %} <p class="text-muted text-center">Nenhuma categoria cadastrada. Comece adicionando uma!</p> {% endfor %}

<div class="mt-4 mb-3">
    <a href="{% url 'inicio' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Voltar ao Painel Principal</a>
</div>
{% endblock %}